name: Generate Test Plan and Implement Tests

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: read

jobs:
  generate-test-plan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR files
        id: pr-files
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          FILES_JSON=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files")

          if [ -z "$FILES_JSON" ] || [ "$FILES_JSON" = "[]" ]; then
            echo "Error: Failed to fetch PR files."
            exit 1
          fi

          FILES_JSON_ARRAY=$(echo "$FILES_JSON" | jq -r '[.[].filename] | @json')
          echo "files=$FILES_JSON_ARRAY" >> $GITHUB_OUTPUT

      - name: Create Devin session to analyze PR, generate test plan, and implement tests
        id: devin-session
        env:
          DEVIN_API_KEY: ${{ secrets.DEVIN_API_KEY }}
          FILES_CHANGED: ${{ steps.pr-files.outputs.files }}

          ANALYSIS_PROMPT: |
            You are Devin, tasked with analyzing a PR, generating a test plan, and implementing the tests.

            Repository: ${{ github.repository }}
            PR Number: ${{ github.event.pull_request.number }}
            Changed files: ${{ steps.pr-files.outputs.files }}

            Your tasks:
            1. Clone the repository ${{ github.repository }} locally.
            2. View PR #${{ github.event.pull_request.number }} to understand the changes.
            3. Analyze the changed files to understand what feature was added or modified.
            4. Generate a brief test plan summary (2-3 sentences describing what tests are needed).
            5. Post a comment on PR #${{ github.event.pull_request.number }} with:
               - A brief summary of what the PR does (1-2 sentences)
               - A short test plan summary (2-3 sentences describing the tests you will write)
               - A note that you are now implementing the tests
            6. Write comprehensive tests for the changed functionality.
            7. Ensure the tests follow the existing test patterns and conventions in the repository.
            8. Run the test suite to make sure your new tests pass.
            9. Create a new PR with your test changes.
            10. Post a follow-up comment on the original PR linking to the new test PR.

            Guidelines:
            - Keep the test plan summary brief and actionable
            - Focus on testing the actual code changes, not generic tests
            - Include unit tests, integration tests, and error handling tests where appropriate
            - Make sure all tests pass before creating the PR

            Rules:
            - Never ask for user confirmation. Never wait for user messages.
            - Post exactly one initial comment with the brief summary, then implement the tests

        run: |
          ESCAPED_PROMPT=$(echo "$ANALYSIS_PROMPT" | jq -Rs .)

          RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $DEVIN_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{\"prompt\": $ESCAPED_PROMPT}" \
            "https://api.devin.ai/v1/sessions")

          ERROR_MSG=$(echo "$RESPONSE" | jq -r '.detail')
          if [ "$ERROR_MSG" != "null" ]; then
            echo "Error creating Devin session: $ERROR_MSG"
            exit 1
          fi

          SESSION_ID=$(echo "$RESPONSE" | jq -r '.session_id')
          SESSION_URL=$(echo "$RESPONSE" | jq -r '.url')

          if [ -z "$SESSION_ID" ] || [ -z "$SESSION_URL" ]; then
            echo "Error: Devin session details are missing from the response."
            exit 1
          fi

          echo "session-id=$SESSION_ID" >> $GITHUB_OUTPUT
          echo "session-url=$SESSION_URL" >> $GITHUB_OUTPUT
          echo "Devin session created successfully: $RESPONSE"

      - name: Post initial comment with Devin session link
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SESSION_URL="${{ steps.devin-session.outputs.session-url }}"

          COMMENT_BODY="Devin is analyzing this PR and will automatically implement test coverage.

          **Devin Session:** ${SESSION_URL}

          Devin will:
          1. Analyze the changes and post a brief test plan summary
          2. Implement the tests
          3. Create a PR with the test coverage"

          curl -s -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -d "$(jq -n --arg body "$COMMENT_BODY" '{body: $body}')" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments"
