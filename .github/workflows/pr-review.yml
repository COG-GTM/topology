name: Add Test Coverage

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: read

jobs:
  add-test-coverage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR files
        id: pr-files
        run: |
          FILES=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files" | \
            jq -r '[.[].filename] | @json')

          if [ -z "$FILES" ]; then
            echo "Error: Failed to fetch or parse PR files."
            exit 1
          fi

          echo "files=$FILES" >> $GITHUB_OUTPUT

      - name: Create Devin Session for Test Coverage
        id: devin-test-coverage
        env:
          DEVIN_API_KEY: ${{ secrets.DEVIN_API_KEY }}
          FILES_CHANGED: ${{ steps.pr-files.outputs.files }}

          TEST_COVERAGE_PROMPT: |
            You are Devin, tasked with adding test coverage for a new feature. Your tasks:
            1. Clone the repository ${{ github.repository }} locally.
            2. Check out PR #${{ github.event.pull_request.number }} to get the feature branch.
            3. Analyze the changed files to understand what feature was added or modified.
            4. Write comprehensive tests for the new/modified functionality.
            5. Ensure the tests follow the existing test patterns and conventions in the repository.
            6. Run the existing test suite to make sure your new tests pass and don't break anything.
            7. Create a new PR with your test changes that targets the same base branch as the original PR.

            Rules and Guidelines:
            1. Focus on testing the new functionality introduced in this PR.
            2. Follow the existing test structure and naming conventions in the repository.
            3. Write both unit tests and integration tests where appropriate.
            4. Ensure good test coverage for edge cases and error handling.
            5. Make sure all tests pass before creating the PR.
            6. Commit your changes with a clear message like "Add test coverage for [feature]".
            7. Never ask for user confirmation. Never wait for user messages.

            Changed files in this PR:
            ${{ steps.pr-files.outputs.files }}

        run: |
          ESCAPED_PROMPT=$(echo "$TEST_COVERAGE_PROMPT" | jq -Rs .)

          RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $DEVIN_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{\"prompt\": $ESCAPED_PROMPT}" \
            "https://api.devin.ai/v1/sessions")

          ERROR_MSG=$(echo "$RESPONSE" | jq -r '.detail')
          if [ "$ERROR_MSG" != "null" ]; then
            echo "Error creating Devin session: $ERROR_MSG"
            exit 1
          fi

          SESSION_ID=$(echo "$RESPONSE" | jq -r '.session_id')
          SESSION_URL=$(echo "$RESPONSE" | jq -r '.url')

          if [ -z "$SESSION_ID" ] || [ -z "$SESSION_URL" ]; then
            echo "Error: Devin session details are missing from the response."
            exit 1
          fi

          echo "session-id=$SESSION_ID" >> $GITHUB_OUTPUT
          echo "session-url=$SESSION_URL" >> $GITHUB_OUTPUT
          echo "Devin session created successfully: $RESPONSE"

      - name: Post comment on PR with Devin session link
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SESSION_URL="${{ steps.devin-test-coverage.outputs.session-url }}"
          
          COMMENT_BODY="Devin is working on adding test coverage for this PR.

          **Devin Session:** ${SESSION_URL}

          Devin will create a separate PR with the test coverage once complete. Check the session link above to monitor progress."

          curl -s -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -d "$(jq -n --arg body "$COMMENT_BODY" '{body: $body}')" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments"
