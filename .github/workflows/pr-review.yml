name: Generate Test Plan

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: read

jobs:
  generate-test-plan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR files
        id: pr-files
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          FILES_JSON=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files")

          if [ -z "$FILES_JSON" ] || [ "$FILES_JSON" = "[]" ]; then
            echo "Error: Failed to fetch PR files."
            exit 1
          fi

          FILES_JSON_ARRAY=$(echo "$FILES_JSON" | jq -r '[.[].filename] | @json')
          echo "files=$FILES_JSON_ARRAY" >> $GITHUB_OUTPUT

      - name: Create Devin session to analyze PR and generate test plan
        id: devin-session
        env:
          DEVIN_API_KEY: ${{ secrets.DEVIN_API_KEY }}
          FILES_CHANGED: ${{ steps.pr-files.outputs.files }}

          ANALYSIS_PROMPT: |
            You are Devin, tasked with analyzing a PR and generating a detailed test plan.

            Repository: ${{ github.repository }}
            PR Number: ${{ github.event.pull_request.number }}
            Changed files: ${{ steps.pr-files.outputs.files }}

            Your tasks:
            1. Clone the repository ${{ github.repository }} locally.
            2. View PR #${{ github.event.pull_request.number }} to understand the changes.
            3. Analyze the changed files to understand what feature was added or modified.
            4. Generate a detailed test plan with specific test cases for each changed file.
            5. Post a comment on PR #${{ github.event.pull_request.number }} with:
               - A summary of what the PR does
               - A detailed test plan with multiple specific test cases for each file
               - For each test case, include: test name, description, expected behavior, and edge cases
               - A prefilled Devin link (https://app.devin.ai/new?prompt=URL_ENCODED_PROMPT) that users can click to start a session to implement the tests

            Guidelines for the test plan:
            - Be specific to the actual code changes, not generic
            - Include unit tests, integration tests, and error handling tests where appropriate
            - Reference specific functions, classes, or methods that need testing
            - Include edge cases and boundary conditions specific to the implementation
            - The prefilled Devin prompt should include the full test plan and instructions to implement it

            Rules:
            - Do NOT make any commits or pushes - only analyze and comment
            - Never ask for user confirmation. Never wait for user messages.
            - Post exactly one comment on the PR with the complete test plan

        run: |
          ESCAPED_PROMPT=$(echo "$ANALYSIS_PROMPT" | jq -Rs .)

          RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $DEVIN_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{\"prompt\": $ESCAPED_PROMPT}" \
            "https://api.devin.ai/v1/sessions")

          ERROR_MSG=$(echo "$RESPONSE" | jq -r '.detail')
          if [ "$ERROR_MSG" != "null" ]; then
            echo "Error creating Devin session: $ERROR_MSG"
            exit 1
          fi

          SESSION_ID=$(echo "$RESPONSE" | jq -r '.session_id')
          SESSION_URL=$(echo "$RESPONSE" | jq -r '.url')

          if [ -z "$SESSION_ID" ] || [ -z "$SESSION_URL" ]; then
            echo "Error: Devin session details are missing from the response."
            exit 1
          fi

          echo "session-id=$SESSION_ID" >> $GITHUB_OUTPUT
          echo "session-url=$SESSION_URL" >> $GITHUB_OUTPUT
          echo "Devin session created successfully: $RESPONSE"

      - name: Post initial comment with Devin session link
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SESSION_URL="${{ steps.devin-session.outputs.session-url }}"

          COMMENT_BODY="Devin is analyzing this PR to generate a detailed test plan.

          **Devin Session:** ${SESSION_URL}

          Once the analysis is complete, Devin will post a comment with:
          - A summary of the PR changes
          - A detailed test plan with specific test cases
          - A link to start a Devin session to implement the tests"

          curl -s -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -d "$(jq -n --arg body "$COMMENT_BODY" '{body: $body}')" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments"
